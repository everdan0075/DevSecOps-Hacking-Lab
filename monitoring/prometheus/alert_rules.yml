groups:
  - name: devsecops-login-alerts
    interval: 15s
    rules:
      - alert: LoginFailureSpike
        expr: increase(login_failed_total[5m]) > 5
        for: 30s
        labels:
          severity: warning
          service: login-api
          category: brute-force
        annotations:
          summary: "High rate of failed login attempts detected"
          description: "More than 5 failed login attempts per minute observed on login-api. Possible brute-force attack."

      - alert: RateLimiterBlocking
        expr: increase(rate_limit_blocks_total[5m]) > 3
        for: 30s
        labels:
          severity: critical
          service: login-api
          category: defense
        annotations:
          summary: "Rate limiter blocking sustained traffic"
          description: "Rate limiter blocked more than 3 requests per minute for login-api. Investigate possible attack."

      - alert: LoginAPIDown
        expr: up{job="login-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: login-api
          category: availability
        annotations:
          summary: "login-api scrape target is down"
          description: "Prometheus cannot reach login-api metrics endpoint for more than 1 minute."

      - alert: MFABypassAttempts
        expr: increase(mfa_attempts_total{result="failure"}[5m]) > 10
        for: 1m
        labels:
          severity: warning
          service: login-api
          category: mfa-attack
        annotations:
          summary: "High rate of failed MFA verification attempts"
          description: "More than 10 failed MFA attempts in 5 minutes. Possible MFA brute-force attack."

      - alert: MFAChallengeExpired
        expr: increase(login_failed_total{reason="mfa_challenge_missing"}[5m]) > 5
        for: 30s
        labels:
          severity: info
          service: login-api
          category: mfa
        annotations:
          summary: "Multiple expired MFA challenges"
          description: "Users are experiencing expired MFA challenges. May indicate slow user response or attack."

      - alert: RefreshTokenAbuse
        expr: increase(jwt_refresh_total{status="denied"}[5m]) > 15
        for: 1m
        labels:
          severity: warning
          service: login-api
          category: token-abuse
        annotations:
          summary: "High rate of invalid refresh token attempts"
          description: "More than 15 rejected refresh token attempts in 5 minutes. Possible token replay attack."

      - alert: TokenRevocationSpike
        expr: increase(jwt_refresh_total{status=~"revoked_.*"}[5m]) > 20
        for: 1m
        labels:
          severity: info
          service: login-api
          category: session-management
        annotations:
          summary: "Unusual token revocation activity"
          description: "High volume of token revocations detected. May indicate compromised sessions or mass logout."

      - alert: IPBanThresholdReached
        expr: increase(ip_bans_total[10m]) > 5
        for: 1m
        labels:
          severity: critical
          service: login-api
          category: defense
        annotations:
          summary: "Multiple IPs banned in short period"
          description: "More than 5 IPs banned in 10 minutes. Indicates distributed attack or aggressive scanning."

      - alert: AuthenticationFlowStalled
        expr: (rate(login_stage_total{stage="password_success"}[5m]) - rate(login_stage_total{stage="mfa_success"}[5m])) > 10
        for: 2m
        labels:
          severity: warning
          service: login-api
          category: user-experience
        annotations:
          summary: "Users completing password but not MFA"
          description: "Significant gap between password success and MFA completion. Users may be struggling with MFA."

  # ============================================================================
  # Phase 2.2: API Gateway & Microservices Security Alerts
  # ============================================================================
  - name: devsecops-gateway-alerts
    interval: 15s
    rules:
      # Gateway Availability
      - alert: APIGatewayDown
        expr: up{job="api-gateway"} == 0
        for: 1m
        labels:
          severity: critical
          service: api-gateway
          category: availability
        annotations:
          summary: "API Gateway is down"
          description: "API Gateway metrics endpoint unreachable for >1 minute. All client traffic blocked."

      # Gateway Bypass - Direct Service Access
      - alert: DirectServiceAccessDetected
        expr: increase(user_service_direct_access_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
          service: user-service
          category: gateway-bypass
        annotations:
          summary: "Direct service access detected (Gateway bypass)"
          description: "More than 10 direct accesses to user-service in 5 minutes. Attacker bypassing API Gateway security controls."
          remediation: "Remove port exposure in docker-compose.yml, implement mTLS"

      - alert: DirectServiceAccessSustained
        expr: rate(user_service_direct_access_total[5m]) > 0.5
        for: 3m
        labels:
          severity: warning
          service: user-service
          category: gateway-bypass
        annotations:
          summary: "Sustained direct service access pattern"
          description: "Continuous direct access to backend services bypassing Gateway. Possible automated attack or misconfiguration."

      # IDOR Exploitation
      - alert: IDORExploitationAttempt
        expr: increase(user_service_idor_attempts_total{result="success"}[5m]) > 5
        for: 1m
        labels:
          severity: critical
          service: user-service
          category: idor
        annotations:
          summary: "IDOR exploitation detected"
          description: "More than 5 successful IDOR attempts in 5 minutes. User accessing unauthorized profiles."
          owasp: "A01:2021 - Broken Access Control"
          remediation: "Add authorization check: authenticated_user == requested_user_id"

      - alert: IDOREnumerationPattern
        expr: count(increase(user_service_idor_attempts_total{result="success"}[1m]) > 0) by (authenticated_user) > 3
        for: 2m
        labels:
          severity: warning
          service: user-service
          category: idor
        annotations:
          summary: "IDOR enumeration pattern detected"
          description: "User sequentially accessing multiple other users' profiles. Profile enumeration attack."

      # Unauthorized Settings Access
      - alert: UnauthorizedSettingsAccess
        expr: increase(user_service_unauthorized_settings_access_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
          service: user-service
          category: auth-bypass
        annotations:
          summary: "Unauthorized access to /settings endpoint"
          description: "More than 10 accesses to /settings without JWT authentication in 5 minutes."
          remediation: "Add JWT validation to /settings endpoint"

      # Gateway Rate Limiting
      - alert: GatewayRateLimitExceeded
        expr: increase(gateway_rate_limit_blocks_total[5m]) > 20
        for: 1m
        labels:
          severity: warning
          service: api-gateway
          category: rate-limiting
        annotations:
          summary: "High rate of requests blocked by rate limiter"
          description: "Gateway rate limiter blocked >20 requests in 5 minutes. Possible DoS attack or aggressive client."

      - alert: GatewayRateLimitBypass
        expr: (rate(user_service_requests_total[5m]) / rate(gateway_requests_total[5m])) > 1.5
        for: 2m
        labels:
          severity: critical
          service: api-gateway
          category: rate-limiting
        annotations:
          summary: "Rate limit bypass detected"
          description: "Backend receiving significantly more traffic than Gateway. Rate limiting bypassed via direct access."

      # WAF Blocks
      - alert: WAFBlockSpike
        expr: increase(gateway_waf_blocks_total[5m]) > 10
        for: 1m
        labels:
          severity: warning
          service: api-gateway
          category: waf
        annotations:
          summary: "High rate of WAF blocks"
          description: "WAF blocked >10 suspicious requests in 5 minutes. Active attack detected (SQL injection, XSS, etc.)"

      - alert: WAFSQLInjectionAttempt
        expr: increase(gateway_waf_blocks_total{attack_type="sql_injection"}[5m]) > 5
        for: 30s
        labels:
          severity: critical
          service: api-gateway
          category: waf
        annotations:
          summary: "SQL injection attack detected"
          description: "WAF detected and blocked SQL injection attempts. Immediate investigation required."

      # JWT Validation Failures
      - alert: GatewayJWTValidationFailureSpike
        expr: increase(gateway_jwt_validation_failures_total[5m]) > 15
        for: 1m
        labels:
          severity: warning
          service: api-gateway
          category: jwt
        annotations:
          summary: "High rate of JWT validation failures"
          description: "More than 15 JWT validation failures in 5 minutes. Possible token tampering or replay attack."

      - alert: ExpiredTokenFlood
        expr: increase(gateway_jwt_validation_failures_total{reason="expired"}[5m]) > 20
        for: 1m
        labels:
          severity: info
          service: api-gateway
          category: jwt
        annotations:
          summary: "Many expired token attempts"
          description: "High volume of expired JWT tokens. Users not refreshing tokens properly or cached tokens reused."

      # Backend Service Health
      - alert: UserServiceDown
        expr: up{job="user-service"} == 0
        for: 1m
        labels:
          severity: critical
          service: user-service
          category: availability
        annotations:
          summary: "User Service is down"
          description: "User Service metrics endpoint unreachable. Profile and settings endpoints unavailable."

      - alert: BackendServiceError
        expr: increase(gateway_backend_errors_total[5m]) > 10
        for: 1m
        labels:
          severity: critical
          service: api-gateway
          category: backend-health
        annotations:
          summary: "High backend service error rate"
          description: "Gateway receiving errors from backend services. Check backend health and logs."

      # Performance Degradation
      - alert: GatewayHighLatency
        expr: histogram_quantile(0.95, rate(gateway_request_duration_seconds_bucket[5m])) > 2
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          category: performance
        annotations:
          summary: "Gateway experiencing high latency"
          description: "95th percentile request duration >2 seconds. Performance degradation or under attack."

      - alert: BackendHighLatency
        expr: histogram_quantile(0.95, rate(gateway_backend_request_duration_seconds_bucket[5m])) > 1.5
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          category: performance
        annotations:
          summary: "Backend services responding slowly"
          description: "95th percentile backend response time >1.5 seconds. Investigate backend performance."

  # ============================================================================
  # Phase 2.4: Honeypot & Advanced Threat Detection Alerts
  # ============================================================================
  - name: devsecops-honeypot-alerts
    interval: 15s
    rules:
      # Honeypot - Critical Severity (High-value targets)
      - alert: HoneypotCriticalHit
        expr: increase(gateway_honeypot_hits_total{severity="critical"}[5m]) > 0
        for: 10s
        labels:
          severity: critical
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Critical honeypot endpoint accessed"
          description: "Attacker accessed critical honeypot (secrets, API keys, .env file). Immediate investigation required."
          recommended_actions: "Ban IP, review logs, check for data exfiltration attempts"

      # Honeypot - Reconnaissance Pattern
      - alert: HoneypotReconnaissanceDetected
        expr: count(increase(gateway_honeypot_hits_total[10m]) > 0) by (honeypot_type) >= 3
        for: 1m
        labels:
          severity: high
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Multiple honeypot types accessed (reconnaissance)"
          description: "Attacker probing 3+ different honeypot endpoints. Active reconnaissance phase detected."
          attack_stage: "Reconnaissance"
          recommended_actions: "Monitor IP for further activity, prepare for exploitation attempts"

      # Honeypot - Unique Attackers Spike
      - alert: HoneypotUniqueAttackersSpike
        expr: gateway_honeypot_unique_attackers > 5
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Multiple unique IPs hitting honeypots"
          description: "5+ different IPs accessing honeypot endpoints. Possible distributed attack or automated scanning."

      # Honeypot - Admin Panel Attacks
      - alert: HoneypotAdminPanelAttack
        expr: increase(gateway_honeypot_hits_total{honeypot_type=~"admin_panel.*"}[10m]) > 3
        for: 1m
        labels:
          severity: high
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Admin panel honeypot targeted"
          description: "Multiple attempts to access fake admin panel. Targeted attack on administrative interfaces."
          attack_type: "Admin panel brute force"

      # Honeypot - Database Admin Tools
      - alert: HoneypotDatabaseToolsAttack
        expr: increase(gateway_honeypot_hits_total{honeypot_type="phpmyadmin"}[10m]) > 2
        for: 1m
        labels:
          severity: high
          service: api-gateway
          category: honeypot
        annotations:
          summary: "phpMyAdmin honeypot accessed"
          description: "Attacker searching for phpMyAdmin. Database administration tool exploitation attempt."
          attack_type: "Database admin panel attack"

      # Honeypot - WordPress Scanning
      - alert: HoneypotWordPressScan
        expr: increase(gateway_honeypot_hits_total{honeypot_type="wordpress"}[10m]) > 5
        for: 1m
        labels:
          severity: medium
          service: api-gateway
          category: honeypot
        annotations:
          summary: "WordPress honeypot triggered"
          description: "Automated WordPress scanner detected. Common attack bot probing for CMS vulnerabilities."
          attack_type: "CMS exploitation"

      # Honeypot - Secret Files Access
      - alert: HoneypotSecretFilesAccess
        expr: increase(gateway_honeypot_hits_total{honeypot_type=~"secret_file_.*|api_.*"}[5m]) > 0
        for: 10s
        labels:
          severity: critical
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Attacker accessing secret files/API keys"
          description: "Direct attempt to steal credentials via .env, API keys, or secret files. Critical threat."
          attack_type: "Credential theft"
          recommended_actions: "IMMEDIATE: Ban IP, alert security team, check for data breach"

      # Honeypot - Git Exposure
      - alert: HoneypotGitExposure
        expr: increase(gateway_honeypot_hits_total{honeypot_type=~"git_.*"}[10m]) > 0
        for: 30s
        labels:
          severity: high
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Git repository exposure attempt"
          description: "Attacker probing for exposed .git directory. Source code theft attempt."
          attack_type: "Source code theft"
          recommended_actions: "Ban IP, review repository security"

      # Honeypot - Backup File Hunting
      - alert: HoneypotBackupFileHunt
        expr: increase(gateway_honeypot_hits_total{honeypot_type=~"backup_.*"}[10m]) > 0
        for: 30s
        labels:
          severity: high
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Backup file download attempt"
          description: "Attacker searching for backup files (.sql, .zip). Data exfiltration attempt."
          attack_type: "Data exfiltration"

      # Honeypot - Sustained Attack
      - alert: HoneypotSustainedAttack
        expr: rate(gateway_honeypot_hits_total[10m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Sustained honeypot attack pattern"
          description: "Continuous honeypot hits over 5+ minutes. Persistent attacker or automated attack tool."
          recommended_actions: "Enable enhanced monitoring, consider IP blocking at firewall level"

      # Honeypot - Multi-stage Attack Indicator
      - alert: HoneypotMultiStageAttack
        expr: |
          (count(increase(gateway_honeypot_hits_total{severity="critical"}[15m]) > 0) by (honeypot_type) >= 1)
          and
          (count(increase(gateway_honeypot_hits_total{severity=~"high|medium"}[15m]) > 0) by (honeypot_type) >= 2)
        for: 1m
        labels:
          severity: critical
          service: api-gateway
          category: honeypot
        annotations:
          summary: "Multi-stage attack detected (honeypot correlation)"
          description: "Attacker progressed from reconnaissance to critical target access. Advanced persistent threat indicator."
          attack_stage: "Multi-stage (Reconnaissance â†’ Exploitation)"
          recommended_actions: "ESCALATE: Alert security team, enable full packet capture, review all attacker activity"

